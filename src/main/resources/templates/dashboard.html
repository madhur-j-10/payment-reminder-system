<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }

        h1, h2 {
            color: #f0f0f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #1e1e1e;
        }

        .btn {
            padding: 6px 10px;
            margin: 5px 0;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn-green {
            background-color: #2e7d32;
            color: white;
        }

        .btn-red {
            background-color: #c62828;
            color: white;
        }

        .btn-blue {
            background-color: #1565c0;
            color: white;
        }

        form {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #333;
            background-color: #1a1a1a;
            border-radius: 6px;
        }

        input, select, textarea {
            width: 100%;
            margin-bottom: 12px;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #2c2c2c;
            color: #eee;
        }

        select option {
            background-color: #2c2c2c;
            color: #eee;
        }

        /* Responsive table */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr {
                display: block;
                width: 100%;
            }

            thead {
                display: none;
            }

            tr {
                margin-bottom: 15px;
                background-color: #1e1e1e;
                border: 1px solid #444;
                padding: 10px;
                border-radius: 6px;
            }

            td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
                border-bottom: 1px solid #444;
            }

            td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-left: 10px;
                font-weight: bold;
                color: #bbb;
                text-align: left;
            }

            .btn {
                width: 100%;
            }

            form {
                padding: 10px;
            }
        }
    </style>


</head>
<body>

<h1>Payment Dashboard</h1>

<h2 id="user_name"></h2>

<button class="btn btn-blue" onclick="logout()">Logout</button>

<h2>Your Payments</h2>
<table>
    <thead>
    <tr>
        <th>Name</th>
        <th>Amount</th>
        <th>Category</th>
        <th>Deadline</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="paymentsTable">
    <!-- Payments loaded via JS -->
    </tbody>
</table>

<h2>Add New Payment</h2>
<form id="addPaymentForm">
    <input type="text" name="paymentName" placeholder="Payment Name" required>
    <textarea name="description" placeholder="Description"></textarea>
    <input type="number" step="0.01" name="amount" placeholder="Amount (in â‚¹)" required>
    <select name="category" required>
        <option value="bills">Bills</option>
        <option value="subscription">Subscription</option>
        <option value="loan">Loan</option>
        <option value="tax">Tax</option>
        <option value="other">Other</option>
    </select>
    <input type="datetime-local" name="deadline" required>
    <button type="submit" class="btn btn-green">Add Payment</button>
</form>

<script>


    // Load Payments
    async function loadPayments() {

        const user_name_response = await fetch("/api/payments/user",{
                method : "GET",
                credentials: "include"
         });
         const user_name = await user_name_response.text();
         document.getElementById("user_name").innerText = `User: ${user_name}`;



        // res --> promise (fetch returns promise)
        const res = await fetch("/api/payments", { credentials: "include" });

        // 401 -- unauthorized(invalid or expired jwt)

        if (res.status === 401) { window.location.href = "/auth/register"; return; }

        // data --> promise (.json() return promise)
        const data = await res.json(); //[json data --> Js object]

        const table = document.getElementById("paymentsTable");
        table.innerHTML = "";


        // data --> array of object(payment)
        //.forEach(callback(element,index,arr),thisVal)
        // payment --> object(element) and its  attributes -->[paymentName,amount,category,deadline,status]

        data.forEach((payment) => {
            table.innerHTML += `
                <tr>
                    <td data-label="Name">${payment.paymentName}</td>
                    <td data-label="Amount">${payment.amount}</td>
                    <td data-label="Category">${payment.category}</td>
                    <td data-label="Deadline">${payment.deadline}</td>
                    <td data-label="Status">${payment.status}</td>
                    <td data-label="Actions">
<!--                        <button class="btn btn-green" onclick="updateStatus(${payment.paymentId}, 'PAID')">Mark Paid</button>-->
<!--                        <button class="btn btn-green" onclick="updateStatus(${payment.paymentId}, 'PENDING')">Mark Pending</button>-->
<!--                        <button class="btn btn-green" onclick="updateStatus(${payment.paymentId}, 'CANCELLED')">Mark Cancelled</button>-->


                               <select onchange="updateStatus(this)" data-id="${payment.paymentId}">
                                  <option disabled selected>Change Status</option>
                                  <option value="PENDING">Pending</option>
                                  <option value="PAID">Paid</option>
                                  <option value="CANCELLED">Cancelled</option>
                                </select>
                        <button class="btn btn-red" onclick="deletePayment(${payment.paymentId})">Delete</button>
                    </td>
                </tr>`;
        });
    }

    //  Add Payment

    //e --> event object [contains info about event, in this case form submission]

    document.getElementById("addPaymentForm").addEventListener("submit", async (e) => {

        e.preventDefault();

        // FormData --> built-in Js object
        // e.target refers to form itself


        const formData = new FormData(e.target);

        // converts FormData object --> plain JS object
        //data --> plain JS object
        const data = Object.fromEntries(formData.entries());

        //String --> number conversion
        data.amount = parseFloat(data.amount);

        await fetch("/api/payments", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)    //converts JS object(data) --> JSON object (body)
        });
        e.target.reset(); //clears form input

        loadPayments(); //show payment in table
    });

    //  Update Status


    async function updateStatus(selectElement) {

        const id = selectElement.getAttribute("data-id");
        const status = selectElement.value;

        if (!id || !status) return;

        await fetch(`/api/payments/${id}/status?status=${status}`, {
            method: "PATCH",
            credentials: "include"
        });
        loadPayments();
    }

    // Delete Payment
    async function deletePayment(id) {
        await fetch(`/api/payments/${id}`, {
            method: "DELETE",
            credentials: "include"
        });
        loadPayments();
    }

    // Logout
    async function logout() {
        await fetch("/logout", { method: "POST", credentials: "include" });
        window.location.href = "/auth/register";
    }

    // Load on page start
    loadPayments();
</script>

</body>
</html>
